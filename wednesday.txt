Wednesday, September 18th
=========================

Morning: Short reads & mapping
------------------------------

Lecture: sequencing basics
***************************

Mapping with bwa
*****************

One of the most common operations when dealing with NGS data is mapping sequences
to other sequences, and most commonly, mapping reads to a reference. Because
short read alignment is so common, there is a deluge of programs available for doing
it, and it is well-understood problem. Most of the efficient programs work by first
building an *index* of the sequence that will be mapped to, which allows for
extremely fast lookups, and then running a separate module which uses that index
to align short sequences against the reference. Alignment is used for visualization,
coverage estimation, SNP calling, expression analysis, and a slew of other problems.
For a high-level overview, try `this NCBI review <http://www.ncbi.nlm.nih.gov/pmc/articles/PMC2836519/>`__.

Getting the Dependencies
````````````````````````

bwa is a tool meant for quickly aligning short reads to a reference. While there
are more mappers out there than anyone would care to enumerate, bwa is a good
"reference" version of the most common algorithm and is relatively popular.

Firstly, let's download bwa::

    cd /root
    curl -L "http://downloads.sourceforge.net/project/bio-bwa/bwa-0.7.5a.tar.bz2?r=http%3A%2F%2Fsourceforge.net%2Fprojects%2Fbio-bwa%2Ffiles%2F&ts=1379347638&use_mirror=softlayer-dal" > bwa-0.7.5a.tar.bz2

And then decompress it::

    tar xjf bwa-0.7.5a.tar.bz2

Now, change into the directory with the source code and compile it::

    cd bwa-0.7.5a/
    make
    
Finally, move the compiled executable to a location where the operating system
can find it::

    cp bwa /usr/local/bin

So what did we actually just do? bwa is offered as an open-source program -- that
is, the actual code which defines its functionality is freely availabe. However,
bwa is written in C, which, unlike Python, is not "interpretted." Instead, the
source code needs to be parsed and converted into machine language which can be
run on the processor. This allows compiled programs to run much more efficiently 
than their interpretted counterparts, at the cost of needing to be recompiled for
different systems. Although pre-compiled executables can be found for many programs,
Unix programs are often distributed as source. 'make' is a program for tracking
dependencies amongst files, and is used to manage the compilation of larger
projects with many files.

Now, we need to grab a few more dependencies. We'll download screed, which is
a simple python module for parsing fasta files developed by our lab at MSU::

    pip install screed

And then khmer, which is a Python interface to a really fast (and awesome) piece
of software for counting k-mers (more on that later)::

    cd /usr/local/share
    git clone https://github.com/ged-lab/khmer.git
    cd khmer
    git checkout 2013-caltech-cemi
    make

Now that we've downloaded and built khmer, we'll add it to the system's python
PATH so that our scripts now where to find it::

    echo 'export PYTHONPATH=/usr/local/share/khmer/python' >> ~/.bashrc
    source ~/.bashrc


Get Some Test Data
```````````````````

We've got the programs we need, so now let's get some data to play with. Everybody
*loves* ecoli, so we'll grab a reference genome of the k-12 strain. The program
we'll use is called curl, which grabs data from a URL and spits it out to
the terminal; using the > sign, we can direct that output into a file, like so::

    curl http://www.genome.wisc.edu/pub/sequence/U00096.2.fas > ecoli_k12.fa

The > sign is a general UNIX construct for redirecting a 'stream' to a file. You'll
see it relatively often.

We've got a reference genome, 
curl -O https://s3.amazonaws.com/public.ged.msu.edu/ecoli_ref-5m.fastq.gz

# split the paired reads into their left and right components 
python /usr/local/share/khmer/scripts/split-paired-reads.py ecoli_ref-5m.fastq.gz 


# build the FM-index of the reference for the alignment algorithm
bwa index -a bwtsw ecoli_k12.fa 

# just grab a subset of the reads for demonstration purposes
head -n 50000 ecoli_ref-5m.fastq.gz.1 > left.fa
head -n 50000 ecoli_ref-5m.fastq.gz.2 > right.fa

# perform the alignment using bwa mem and output to same
bwa mem -t 4 ecoli_k12.fa left.fa right.fa > aln.x.ecoli_k12.sam

# now convert the output to bam and sorted bam for viewing
# with your viewer of choice, say table
samtools view -uS aln.x.ecoli_k12.sam > aln.x.ecoli_k12.bam
samtools sort aln.x.ecoli_k12.bam aln.x.ecoli_k12.bam.sorted
samtools index aln.x.ecoli_k12.bam.sorted.bam


http://www.ncbi.nlm.nih.gov/pubmed/22522955
http://www.ebi.ac.uk/ena/data/view/SRA048664  (see files athyra:~t/cit/)

Building a SAM file.
Calling SNPs
Tablet.

http://ged.msu.edu/angus/tutorials-2013/bwa-tutorial.html

Afternoon: QC; Assembly
-----------------------

Assembly exercise?

Looking at mapping mismatches:
http://ged.msu.edu/angus/tutorials-2013/plot-mapping-mismatches.html


Quality trimming
QC and FASTQ:
http://ged.msu.edu/angus/tutorials-2013/short-read-quality-evaluation.html

Assembling E. coli
http://ged.msu.edu/angus/tutorials-2013/assembling-ecoli-with-velvet.html
Velvet
SPADES
idba

Evaluating assemblies.
Comparing assemblies. (?)

Q: Do we want to do the assembly & mapping exercise?)
